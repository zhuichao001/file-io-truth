## 零拷贝技术

#### 数据的四次拷贝与四次上下文切换
_很多应用程序在面临客户端请求时，可以等价为进行如下的系统调用：_  
```
File.read(file, buf, len);
Socket.send(socket, buf, len);
```
如静态web服务器是这个应用场景，从磁盘中读取页面原封不动地写入网卡（NIC，Network interface controller）进行发送。  
在没有任何优化技术使用的背景下，操作系统为此会进行 4 次数据拷贝，以及 4 次上下文切换，如下图所示：

<img src="" />

#### 4 次 copy：
物理设备 <-> 内存：
CPU 负责将数据从磁盘搬运到内核空间的 Page Cache 中；
CPU 负责将数据从内核空间的 Socket 缓冲区搬运到的网络中；
内存内部拷贝：
CPU 负责将数据从内核空间的 Page Cache 搬运到用户空间的缓冲区；
CPU 负责将数据从用户空间的缓冲区搬运到内核空间的 Socket 缓冲区中；

4 次上下文切换：
read 系统调用时：用户态切换到内核态；
read 系统调用完毕：内核态切换回用户态；
write 系统调用时：用户态切换到内核态；
write 系统调用完毕：内核态切换回用户态；

可以看出如果没有优化，读取磁盘数据，再通过网卡传输的场景性能比较差：

#### 零拷贝技术
什么是零拷贝技术？   
> 零拷贝技术是一个思想[3]，指的是指计算机执行操作时，CPU 不需要先将数据从某处内存复制到另一个特定区域。

_可见，零拷贝的特点是 CPU 不全程负责内存中的数据写入其他组件，CPU 仅仅起到管理的作用。如果数据本身不在内存中，那么必须先通过某种方式拷贝到内存中（这个过程 CPU 可以仅仅负责管理，辅助硬件（如DMAC）来负责具体数据拷贝），才能被 CPU 直接读取计算。_  

零拷贝技术的具体实现方式有哪些？  
- DMA 技术：DMA 负责内存与其他组件之间的数据拷贝，CPU 仅需负责管理，而无需负责全程的数据拷贝；
使用 page cache 的 zero copy：
- sendfile：用户从磁盘读取一些文件数据后不需要经过任何计算与处理就通过网络传输出去，一次系统调用代替 read/write (两次)系统调用，通过使用 DMA 技术以及传递文件描述符，实现了 zero copy
- mmap：仅代替 read 系统调用，将内核空间地址映射为用户空间地址，write 操作直接作用于内核空间。通过 DMA 技术以及地址映射技术，用户空间与内核空间无须数据拷贝，实现了 zero copy
- Direct I/O：读写操作直接在磁盘上进行，不使用 page cache 机制，通常结合用户空间的用户缓存使用。通过 DMA 技术直接与磁盘/网卡进行数据交互，实现了 zero copy
